import streamlit as st
import pandas as pd
import random
from collections import Counter

st.set_page_config(page_title="è±¡æ£‹åœå¦ AI è§£ç›¤", page_icon="â™Ÿï¸")
st.title("â™Ÿï¸ è±¡æ£‹åœå¦ AI å åœç³»çµ±ï¼ˆéš¨æ©ŸæŠ½å¦ï¼‰")

# å»ºç«‹32é¡†è±¡æ£‹è³‡æ–™ï¼ˆç´…é»‘å„16ï¼‰
chess_pool = ["ç´…å¸¥"] + ["ç´…å£«"]*2 + ["ç´…ç›¸"]*2 + ["ç´…è»Š"]*2 + ["ç´…é¦¬"]*2 + ["ç´…ç‚®"]*2 + ["ç´…å…µ"]*5 + \
             ["é»‘å°‡"] + ["é»‘å£«"]*2 + ["é»‘è±¡"]*2 + ["é»‘ä¿¥"]*2 + ["é»‘å‚Œ"]*2 + ["é»‘åŒ…"]*2 + ["é»‘å’"]*5

# æ£‹å­äº”è¡Œèˆ‡æƒ…ç·’å°æ‡‰
chess_db = {
    "å¸¥": {"äº”è¡Œ": "é‡‘", "æ€§æ ¼": "é ˜å°ã€æŒæ§", "æƒ…ç·’": "æ§åˆ¶æ…¾ã€å£“åŠ›å¤§", "èº«é«”": "è…¦ã€ç¥ç¶“ç³»çµ±"},
    "å°‡": {"äº”è¡Œ": "é‡‘", "æ€§æ ¼": "é ˜å°ã€æŒæ§", "æƒ…ç·’": "æ§åˆ¶æ…¾ã€å£“åŠ›å¤§", "èº«é«”": "è…¦ã€ç¥ç¶“ç³»çµ±"},
    "å£«": {"äº”è¡Œ": "é‡‘", "æ€§æ ¼": "æ–‡éœã€å®ˆè­·", "æƒ…ç·’": "å£“æŠ‘ã€æ†‚é¬±", "èº«é«”": "è‚ºã€å¤§è…¸"},
    "ä»•": {"äº”è¡Œ": "é‡‘", "æ€§æ ¼": "æ–‡éœã€å®ˆè­·", "æƒ…ç·’": "å£“æŠ‘ã€æ†‚é¬±", "èº«é«”": "è‚ºã€å¤§è…¸"},
    "ç›¸": {"äº”è¡Œ": "æ°´", "æ€§æ ¼": "ç©©é‡ã€æ…¢ç†±", "æƒ…ç·’": "ç–‘æ…®ã€é€€ç¸®", "èº«é«”": "è…ã€å°è…¸"},
    "è±¡": {"äº”è¡Œ": "æ°´", "æ€§æ ¼": "ç©©é‡ã€æ…¢ç†±", "æƒ…ç·’": "ç–‘æ…®ã€é€€ç¸®", "èº«é«”": "è…ã€å°è…¸"},
    "è»Š": {"äº”è¡Œ": "æœ¨", "æ€§æ ¼": "åŸ·è¡ŒåŠ›å¼·", "æƒ…ç·’": "æ†¤æ€’ã€è¡Œå‹•è¡å‹•", "èº«é«”": "è‚ã€ç­‹"},
    "ä¿¥": {"äº”è¡Œ": "æœ¨", "æ€§æ ¼": "åŸ·è¡ŒåŠ›å¼·", "æƒ…ç·’": "æ†¤æ€’ã€è¡Œå‹•è¡å‹•", "èº«é«”": "è‚ã€ç­‹"},
    "é¦¬": {"äº”è¡Œ": "æœ¨", "æ€§æ ¼": "å¥”æ”¾ã€æ©Ÿå‹•", "æƒ…ç·’": "ç„¦èºã€ä¸ç©©å®š", "èº«é«”": "å››è‚¢ã€è‚Œè‚‰"},
    "å‚Œ": {"äº”è¡Œ": "æœ¨", "æ€§æ ¼": "å¥”æ”¾ã€æ©Ÿå‹•", "æƒ…ç·’": "ç„¦èºã€ä¸ç©©å®š", "èº«é«”": "å››è‚¢ã€è‚Œè‚‰"},
    "ç‚®": {"äº”è¡Œ": "ç«", "æ€§æ ¼": "è°æ˜ã€è®ŠåŒ–å¿«", "æƒ…ç·’": "ææ‡¼ã€æ³¢å‹•", "èº«é«”": "è…ä¸Šè…ºã€æ³Œå°¿"},
    "åŒ…": {"äº”è¡Œ": "ç«", "æ€§æ ¼": "è°æ˜ã€è®ŠåŒ–å¿«", "æƒ…ç·’": "ææ‡¼ã€æ³¢å‹•", "èº«é«”": "è…ä¸Šè…ºã€æ³Œå°¿"},
    "å…µ": {"äº”è¡Œ": "åœŸ", "æ€§æ ¼": "è¸å¯¦ã€åŠªåŠ›", "æƒ…ç·’": "éåº¦æ€æ…®", "èº«é«”": "è„¾èƒƒ"},
    "å’": {"äº”è¡Œ": "åœŸ", "æ€§æ ¼": "è¸å¯¦ã€åŠªåŠ›", "æƒ…ç·’": "éåº¦æ€æ…®", "èº«é«”": "è„¾èƒƒ"},
}

positions = ["ä¸­ï¼ˆ1ï¼‰", "å·¦ï¼ˆ2ï¼‰", "å³ï¼ˆ3ï¼‰", "ä¸Šï¼ˆ4ï¼‰", "ä¸‹ï¼ˆ5ï¼‰"]

# æ ¼å±€æ¢ä»¶åˆ†æ
def detect_patterns(pieces):
    names = [p[1:] for p in pieces]
    patterns = []
    if names.count("é¦¬") + names.count("å‚Œ") >= 2:
        patterns.append("å¥½å‹æ ¼ï¼šé›™é¦¬ï¼Œæœ‹å‹åŠ©åŠ›æˆ–è¡çª")
    if "é¦¬" in names and ("ç‚®" in names or "åŒ…" in names):
        patterns.append("æ¡ƒèŠ±æ ¼ï¼šé¦¬ï¼‹ç‚®ï¼Œæ„Ÿæƒ…è®ŠåŒ–å¤š")
    if names[1] == names[2] == names[3]:
        patterns.append("é›¨å‚˜æ ¼ï¼šä¸­å±¤åŒè‰²ä¿è­·åŠ›ä½†å£“åŠ›å¤§")
    if len(set(names).intersection(["è»Š", "é¦¬", "ç‚®", "ä¿¥", "å‚Œ", "åŒ…"])) >= 3:
        patterns.append("äº‹æ¥­æ ¼ï¼šè¡Œå‹•æ£‹å¤šï¼Œå£“åŠ›èˆ‡æŒ‘æˆ°ä¸¦å­˜")
    return patterns

# èŠ±ç²¾æ¨è–¦
def flower_essence_recommendation(elements, patterns):
    recs = []
    if elements.get("é‡‘", 0) >= 2:
        recs.append("Vervain / Vineï¼šæ§åˆ¶èˆ‡å£“åŠ›å‹æƒ…ç·’")
    if elements.get("ç«", 0) >= 1:
        recs.append("Cherry Plum / Impatiensï¼šç©©å®šç„¦èºèˆ‡æƒ…ç·’")
    if elements.get("åœŸ", 0) >= 2:
        recs.append("White Chestnutï¼šæ¸…é™¤æ€ç·’èˆ‡ç¡çœ å£“åŠ›")
    if any("ç„¦æ…®" in p or "é›¨å‚˜æ ¼" in p for p in patterns):
        recs.append("Mimulusï¼šé‡‹æ”¾ç„¦æ…®èˆ‡å…§åœ¨å£“åŠ›")
    if any("æ¡ƒèŠ±" in p for p in patterns):
        recs.append("Holly / Chicoryï¼šé‡æ¸…æ„Ÿæƒ…ç³¾çµèˆ‡ä½”æœ‰")
    return recs

# æŠ½å¦æŒ‰éˆ•
if st.button("ğŸ”® æŠ½å¦ï¼ˆå¾32é¡†è±¡æ£‹éš¨æ©ŸæŠ½5é¡†ï¼‰"):
    draw = random.sample(chess_pool, 5)
    elements = []
    rows = []
    for i, piece in enumerate(draw):
        color = piece[0]
        name = piece[1:]
        pos = positions[i]
        data = chess_db.get(name, {})
        elements.append(data.get("äº”è¡Œ", ""))
        rows.append({
            "ä½ç½®": pos,
            "æ£‹å­": piece,
            "äº”è¡Œ": data.get("äº”è¡Œ"),
            "æ€§æ ¼": data.get("æ€§æ ¼"),
            "æƒ…ç·’": data.get("æƒ…ç·’"),
            "èº«é«”": data.get("èº«é«”")
        })

    df_result = pd.DataFrame(rows)
    st.subheader("ğŸ§© å åœçµæœï¼š")
    st.dataframe(df_result, use_container_width=True)

    # äº”è¡Œåˆ†æ
    counts = pd.Series(elements).value_counts().to_dict()
    st.write("### äº”è¡Œåˆ†ä½ˆï¼š")
    st.json(counts)

    # æ ¼å±€åˆ†æ
    patterns = detect_patterns(draw)
    st.write("### æ ¼å±€åˆ†æï¼š")
    st.success("\\n".join(patterns) if patterns else "æœªè§¸ç™¼æ˜é¡¯æ ¼å±€")

    # èŠ±ç²¾å»ºè­°
    flowers = flower_essence_recommendation(counts, patterns)
    st.write("### ğŸŒ¸ èŠ±ç²¾å»ºè­°ï¼š")
    st.warning("ã€".join(flowers) if flowers else "ç›®å‰ç„¡ç‰¹åˆ¥èŠ±ç²¾å»ºè­°ï¼Œå¯æŒçºŒè§€å¯Ÿæƒ…ç·’è®ŠåŒ–")
